@ECHO OFF
echo BY INSTALLING THE SOFTWARE, YOU ARE AGREEING TO BE BOUND BY THE BlackBerry 
echo Solution License Agreement which can be reviewed at www.blackberry.com/leg-
echo al/bbsla. IF YOU HAVE ANY QUESTIONS OR CONCERNS ABOUT THE TERMS OF THIS AG-
echo REEMENT, PLEASE CONTACT blackberry AT LEGALinfo@BLACKBERRY.COM. PLEASE READ
echo THIS DOCUMENT CAREFULLY BEFORE INSTALLING OR USING THE SOFTWARE.
echo ***************************************************************************
echo.
set BIN=.\host\windows-x86\bin
set IMG=.\img
set FASTBOOT=fastboot.exe

echo Note:If device is not in fastboot mode
echo Please switch to fastboot mode by holding the power and volume down key for 30s
for /f "tokens=1 delims=" %%i in ('%BIN%\fastboot.exe getvar device 2^>^&1 ^| findstr device ') do (set var1=%%i)
set devname=%var1:device:=%
set devname=%devname: =%
if "%devname%" == "" (
    echo Failed to detect the device name
    GOTO End
)
for /f "tokens=1 delims=" %%i in ('%BIN%\fastboot.exe getvar variant 2^>^&1 ^| findstr variant ') do (set var1=%%i)
set dev_variant=%var1:variant:=%
set dev_variant=%dev_variant: =%
if "%dev_variant%" == "" (
    echo Failed to detect the device variant
    GOTO End
)
if %dev_variant% == "tmo" set dev_variant=global
if %dev_variant% == "cdma" set dev_variant=global
for /f "tokens=1 delims=" %%i in ('%BIN%\fastboot.exe getvar subvariant 2^>^&1 ^| findstr subvariant ') do (set var1=%%i)
set dev_subvariant=%var1:subvariant:=%
set dev_subvariant=%dev_subvariant: =%
set devname_sig=%dev_subvariant%
if "%dev_subvariant%" == "" set dev_subvariant=common

set /P answer=This script will wipe off all user data. Do you want to continue? [y/n]:
if "%answer%" == "n" ( GOTO End
) else if "%answer%" == "y" ( GOTO COMMANDS
) else ( GOTO Error
)
:COMMANDS
%BIN%\fastboot.exe oem securewipe
ECHO "It may take 5 to 15 minutes to securely wipe the device"
ping -n 5 127.0.0.1 > nul
for /f "tokens=1 delims=" %%i in ('%BIN%\fastboot.exe getvar bootchain-slots 2^>^&1 ^| findstr bootchain-slots ') do (set var1=%%i)
set slots=%var1:bootchain-slots:=%
set slots=%slots: =%
if not "%slots%" == "" (
    set slot=%slots:~1,1%
) else (
    echo "Failed to detect bootchain slots."
    GOTO End
)

%BIN%\%FASTBOOT% flash tz_%slot% %IMG%\tz.mbn
%BIN%\%FASTBOOT% flash devcfg_%slot% %IMG%\devcfg.mbn
%BIN%\%FASTBOOT% flash rpm_%slot% %IMG%\rpm.mbn
%BIN%\%FASTBOOT% flash xbl_%slot% %IMG%\xbl.elf
%BIN%\%FASTBOOT% flash hyp_%slot% %IMG%\hyp.signed.mbn
%BIN%\%FASTBOOT% flash pmic_%slot% %IMG%\pmic.elf
%BIN%\%FASTBOOT% flash abl_%slot% %IMG%\abl.elf
%BIN%\%FASTBOOT% flash cmnlib_%slot% %IMG%\cmnlib.signed.mbn
%BIN%\%FASTBOOT% flash cmnlib64_%slot% %IMG%\cmnlib64.signed.mbn
%BIN%\%FASTBOOT% flash keymaster_%slot% %IMG%\keymaster64.signed.mbn
%BIN%\%FASTBOOT% flash mdtpsecapp_%slot% %IMG%\mdtpsecapp.signed.mbn
%BIN%\%FASTBOOT% oem switch-bootchain:%slot%
%BIN%\%FASTBOOT% reboot bootloader
timeout 10
%BIN%\%FASTBOOT% flash bootsig %IMG%\boot.img%devname_sig%.sig
%BIN%\%FASTBOOT% flash recoverysig %IMG%\recovery.img%devname_sig%.sig
%BIN%\%FASTBOOT% flash boot %IMG%\boot.img
%BIN%\%FASTBOOT% flash recovery %IMG%\recovery.img
%BIN%\%FASTBOOT% flash cache %IMG%\cache.img
%BIN%\%FASTBOOT% flash userdata %IMG%\userdata.img
%BIN%\%FASTBOOT% flash modem %IMG%\NON-HLOS-%dev_variant%.bin
%BIN%\%FASTBOOT% flash dsp %IMG%\dspso.bin
%BIN%\%FASTBOOT% flash bluetooth %IMG%\BTFM.bin
%BIN%\%FASTBOOT% flash vendor %IMG%\vendor.img
%BIN%\%FASTBOOT% flash system %IMG%\system.img
%BIN%\%FASTBOOT% flash oem %IMG%\oem_%dev_subvariant%.img
%BIN%\%FASTBOOT% reboot
GOTO End

:Error
ECHO Please enter y or n! Bye bye!!
:End
echo Press any key to close this window
pause >null
