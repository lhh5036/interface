#! /bin/bash
echo BY INSTALLING THE SOFTWARE, YOU ARE AGREEING TO BE BOUND BY THE BlackBerry
echo Solution License Agreement which can be reviewed at www.blackberry.com/leg-
echo al/bbsla. IF YOU HAVE ANY QUESTIONS OR CONCERNS ABOUT THE TERMS OF THIS AG-
echo REEMENT, PLEASE CONTACT blackberry AT LEGALinfo@BLACKBERRY.COM. PLEASE READ
echo THIS DOCUMENT CAREFULLY BEFORE INSTALLING OR USING THE SOFTWARE.
echo "***************************************************************************"
echo ""
if [[ `uname` = "Linux" ]] ; then
    HOST=host/linux-x86
elif [[ `uname` = "Darwin" ]] ; then
    HOST=host/darwin-x86
else
    echo "Unsupported host"
    exit 1
fi

BIN=./$HOST/bin
IMG=./img
FASTBOOT=fastboot

echo Note:If device is not in fastboot mode
echo Please switch to fastboot mode by holding the power and volume down key for 30s
VAR1=$($BIN/fastboot getvar device 2>&1 | grep "device")
read_dev="${VAR1#*:}"
read_dev=$(echo ${read_dev} | sed 's/[[:space:]]//g');
if [ "${read_dev}" == "" ] || [ "${read_variant}" == "" ]; then
    echo "Failed to detect the device name or variant"
    exit
fi
VAR1=$($BIN/fastboot getvar hlos-sig-tag 2>&1 | grep "hlos-sig-tag")
read_dev="${VAR1#*:}"
read_dev=$(echo ${read_dev} | sed 's/[[:space:]]//g');
read_dev_sig=$read_dev
if [ "" == "${read_dev}" ]; then read_dev=common; fi
VAR2=$($BIN/fastboot getvar variant 2>&1 | grep "variant")
read_dev_variant="${VAR2#*:}"
read_dev_variant=$(echo ${read_dev_variant} | sed 's/[[:space:]]//g');
if [ "dscn" == "${read_dev_variant}" ]; then read_dev_variant=dschina; fi
if [ "cn" == "${read_dev_variant}" ]; then read_dev_variant=china; fi
if [ "indonesia" == "${read_dev_variant}" ]; then read_dev_variant=india; fi
DCFG="devcfg"
if [ "china" == "${read_dev_variant}" ]; then DCFG="devcfg_cn"; fi
if [ "dschina" == "${read_dev_variant}" ]; then DCFG="devcfg_cn"; fi

while true; do
read -p "This script will wipe off all user data, do you want to continue? [y/n]:" answer
    case $answer in
        [Yy] ) break;;
        [Nn] ) exit;;
        * ) echo "Please enter y or n.";;
    esac
done
$BIN/fastboot oem securewipe
echo "It may take 5 to 15 minutes to securely wipe the device"
sleep 5
$BIN/$FASTBOOT flash tz $IMG/tz.mbn
$BIN/$FASTBOOT flash devcfg $IMG/${DCFG}.mbn
$BIN/$FASTBOOT flash rpm $IMG/rpm.mbn
$BIN/$FASTBOOT flash sbl1 $IMG/sbl1_signed.mbn
$BIN/$FASTBOOT flash aboot $IMG/emmc_appsboot.mbn
$BIN/$FASTBOOT flash bootsig $IMG/boot.img${read_dev_sig}.sig
$BIN/$FASTBOOT flash recoverysig $IMG/recovery.img${read_dev_sig}.sig
$BIN/$FASTBOOT flash boot $IMG/boot.img
$BIN/$FASTBOOT flash recovery $IMG/recovery.img
$BIN/$FASTBOOT flash cache $IMG/cache.img
$BIN/$FASTBOOT flash userdata $IMG/userdata.img
$BIN/$FASTBOOT flash modem $IMG/NON-HLOS-${read_dev_variant}.bin
$BIN/$FASTBOOT flash dsp $IMG/adspso.bin
$BIN/$FASTBOOT flash system $IMG/system.img
$BIN/$FASTBOOT flash oem $IMG/oem_${read_dev}.img
$BIN/$FASTBOOT reboot
